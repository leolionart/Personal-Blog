---
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import Section from "../components/Section.astro";
import TagFilter from "../components/TagFilter.astro";
import { getCollection, getEntry } from "astro:content";
import FormattedDate from "../components/FormattedDate.astro";

const title = "Blog"
const subtitle = "Thoughts on product, tech & beyond"

const posts = (await getCollection('posts')).sort(
    (a, b) => new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime()
);

const allTags = Array.from(
    new Set(posts.flatMap(post => post.data.tags || []))
).sort() as string[];

function slugToFilename(slug: string) {
    return slug.replace(/\s+/g, '-').toLowerCase() + '.md';
}
---
<Layout title={title}>
    <Header gridBg>
        <h1 class="text-6 sm:text-8 md:text-12 lg:text-18 xl:text-20 leading-[1.2] font-900">{title}</h1>
        <h2 class="text-2.5 sm:text-3.5 md:text-5 lg:text-7 xl:text-8 leading-[1.2] c-gray-600 dark:c-gray-400 font-300">{subtitle}</h2>
    </Header>
    {allTags.length > 0 && <TagFilter tags={allTags} />}
    <main>
        {posts.map(async (post, i) => {
            const author = await getEntry('authors', post.data.author.id);
            return (
                <Section
                    index
                    source={slugToFilename(post.slug)}
                    fullWidthBorder
                    class="post-section animate-on-scroll"
                    data-tags={post.data.tags?.join(',') || ''}
                >
                    <article class="relative post-article">
                        <div class="post-meta">
                            <span class="text-xs opacity-60">
                                <FormattedDate date={post.data.pubDate} />
                            </span>
                            {post.data.tags && (
                                <div class="flex gap-2 flex-wrap">
                                    {post.data.tags.map((tag: string) => (
                                        <span class="text-xs px-2 py-0.5 border-1 border-gray-300 c-gray-600 dark:border-gray-600 dark:c-gray-400">#{tag}</span>
                                    ))}
                                </div>
                            )}
                        </div>
                        <h2 class="text-4 sm:text-5 md:text-7 lg:text-10 xl:text-12 leading-[1.15] font-900 mt-4 c-gray-900 dark:c-gray-100">{post.data.title}</h2>
                        {post.data.description && (
                            <p class="text-2.5 sm:text-3 md:text-3.5 lg:text-4 xl:text-5 leading-[1.4] mt-2 md:mt-3 c-gray-600 dark:c-gray-400">{post.data.description}</p>
                        )}
                        <div class="mt-6 flex items-center justify-between">
                            <small class="text-xs c-gray-500">by {author?.data.name}</small>
                            <span class="text-xs flex items-center gap-1 c-gray-500 hover:c-gray-900 dark:hover:c-gray-200">
                                Read more â†’
                            </span>
                        </div>
                        <a href={`/blog/${post.slug}`} class="after:content-[''] after:absolute after:inset-0 after:z-1">
                            <span class="sr-only">Read {post.data.title}</span>
                        </a>
                    </article>
                </Section>
            )
        })}
    </main>
</Layout>
<style>
    .post-section :global(.content-container) {
        position: relative;
    }
    .post-article {
        padding-inline: 1rem;
    }
    @media (min-width: 640px) {
        .post-article {
            padding-inline: 1.5rem;
        }
    }
    @media (min-width: 768px) {
        .post-article {
            padding-inline: 2rem;
        }
    }
    @media (min-width: 1024px) {
        .post-article {
            padding-inline: 2.5rem;
        }
    }
    .post-meta {
        display: flex;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
    }
    .post-section:hover :global(.section--source) {
        text-decoration: underline;
    }
</style>
