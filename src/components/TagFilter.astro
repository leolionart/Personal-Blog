---
interface Props {
	tags: string[];
}

const { tags } = Astro.props;
---

<div class="tag-filter-container">
	<div class="border-x-1 border-gray-200 dark:border-gray-800 wrapper mx-auto">
		<div class="tag-filter-wrapper" id="tag-filter-wrapper">
			<button class="tag-btn tag-btn-reset active" data-tag="all">All</button>
			{tags.map((tag) => (
				<button class="tag-btn" data-tag={tag}>#{tag}</button>
			))}
		</div>
	</div>
</div>

<script>
	interface Post {
		element: HTMLElement;
		tags: string[];
	}

	const posts: Post[] = [];
	const selectedTags = new Set<string>();

	function collectPosts() {
		posts.length = 0;
		document.querySelectorAll('.post-section').forEach((section) => {
			const tagsText = section.getAttribute('data-tags');
			posts.push({
				element: section as HTMLElement,
				tags: tagsText ? tagsText.split(',').map((t) => t.trim()) : [],
			});
		});
	}

	function reorderButtons() {
		const wrapper = document.getElementById('tag-filter-wrapper');
		if (!wrapper) return;
		const allBtn = wrapper.querySelector('[data-tag="all"]')!;

		// Move active tags right after "All" button
		selectedTags.forEach(tag => {
			const btn = wrapper.querySelector(`[data-tag="${tag}"]`);
			if (btn) allBtn.after(btn);
		});
	}

	function updateButtonStates() {
		const wrapper = document.getElementById('tag-filter-wrapper');
		if (!wrapper) return;

		wrapper.querySelectorAll('.tag-btn').forEach(btn => {
			const tag = btn.getAttribute('data-tag');
			if (tag === 'all') {
				btn.classList.toggle('active', selectedTags.size === 0);
			} else {
				btn.classList.toggle('active', selectedTags.has(tag!));
			}
		});
	}

	function filterPosts() {
		posts.forEach((post) => {
			if (selectedTags.size === 0) {
				post.element.style.display = '';
			} else {
				const hasTag = Array.from(selectedTags).some(tag => post.tags.includes(tag));
				post.element.style.display = hasTag ? '' : 'none';
			}
		});
	}

	function updateURL() {
		if (selectedTags.size === 0) {
			window.history.replaceState(null, '', window.location.pathname);
		} else {
			const params = new URLSearchParams();
			selectedTags.forEach(tag => params.append('tag', tag));
			window.history.replaceState(null, '', `?${params.toString()}`);
		}
	}

	function handleTagAction(tag: string) {
		if (tag === 'all') {
			selectedTags.clear();
		} else if (selectedTags.has(tag)) {
			selectedTags.delete(tag);
		} else {
			selectedTags.add(tag);
		}
		reorderButtons();
		updateButtonStates();
		filterPosts();
		updateURL();
	}

	function bindWrapper() {
		const wrapper = document.getElementById('tag-filter-wrapper');
		if (!wrapper || (wrapper as any).__bound) return;
		(wrapper as any).__bound = true;

		// Click handler (desktop + some mobile)
		wrapper.addEventListener('click', (e) => {
			const btn = (e.target as Element).closest('.tag-btn');
			if (!btn) return;
			const tag = btn.getAttribute('data-tag');
			if (tag) handleTagAction(tag);
		});

		// iOS Safari / Facebook WebView fix:
		// Touch events inside overflow-x:auto + position:sticky don't bubble
		// to document reliably. Attach directly on the scroll container.
		let touchStart = { x: 0, y: 0 };

		wrapper.addEventListener('touchstart', (e) => {
			if (!(e.target as Element).closest('.tag-btn')) return;
			touchStart = { x: e.touches[0].clientX, y: e.touches[0].clientY };
		}, { passive: true });

		wrapper.addEventListener('touchend', (e) => {
			const btn = (e.target as Element).closest('.tag-btn');
			if (!btn) return;
			const touch = e.changedTouches[0];
			const dx = Math.abs(touch.clientX - touchStart.x);
			const dy = Math.abs(touch.clientY - touchStart.y);
			if (dx < 10 && dy < 10) {
				e.preventDefault();
				const tag = btn.getAttribute('data-tag');
				if (tag) handleTagAction(tag);
			}
		});
	}

	function initialize() {
		selectedTags.clear();
		collectPosts();
		bindWrapper();

		// Restore from URL
		const params = new URLSearchParams(window.location.search);
		params.getAll('tag').forEach(tag => selectedTags.add(tag));
		if (selectedTags.size > 0) {
			reorderButtons();
			updateButtonStates();
			filterPosts();
		}
	}

	initialize();
	document.addEventListener('astro:after-swap', initialize);
</script>

<style>
	.tag-filter-container {
		position: sticky;
		top: 0;
		z-index: 10;
		background-color: rgb(255 255 255);
		border-bottom: 1px solid rgb(229 231 235);
	}

	:global(.dark) .tag-filter-container {
		background-color: rgb(17 24 39);
		border-bottom-color: rgb(55 65 81);
	}

	.tag-filter-wrapper {
		display: flex;
		gap: 0.375rem;
		flex-wrap: nowrap;
		overflow-x: auto;
		scrollbar-width: none;
		padding-inline: 1rem;
		padding-block: 0.625rem;
	}

	.tag-filter-wrapper::-webkit-scrollbar {
		display: none;
	}

	@media (min-width: 640px) {
		.tag-filter-wrapper {
			padding-inline: 1.5rem;
			flex-wrap: wrap;
			overflow-x: visible;
		}
	}

	@media (min-width: 768px) {
		.tag-filter-wrapper { padding-inline: 2rem; }
	}

	@media (min-width: 1024px) {
		.tag-filter-wrapper { padding-inline: 2.5rem; }
	}

	.tag-btn {
		padding: 0.25rem 0.625rem;
		border: 1px solid rgb(209 213 219);
		border-radius: 0;
		background-color: transparent;
		color: rgb(107 114 128);
		cursor: pointer;
		font-size: 0.75rem;
		line-height: 1.5;
		transition: border-color 0.1s, background-color 0.1s, color 0.1s;
		white-space: nowrap;
		font-family: inherit;
		flex-shrink: 0;
	}

	:global(.dark) .tag-btn {
		border-color: rgb(55 65 81);
		color: rgb(156 163 175);
	}

	.tag-btn:active {
		transform: scale(0.95);
		transition: transform 0.06s ease-out;
	}

	.tag-btn:hover {
		border-color: rgb(107 114 128);
		color: rgb(17 24 39);
	}

	:global(.dark) .tag-btn:hover {
		border-color: rgb(156 163 175);
		color: rgb(229 231 235);
	}

	.tag-btn.active {
		background-color: rgb(17 24 39);
		color: rgb(255 255 255);
		border-color: rgb(17 24 39);
	}

	:global(.dark) .tag-btn.active {
		background-color: rgb(243 244 246);
		color: rgb(17 24 39);
		border-color: rgb(243 244 246);
	}

	.tag-btn.active:not(.tag-btn-reset)::after {
		content: ' Ã—';
		opacity: 0.5;
	}

	.tag-btn-reset {
		font-weight: 700;
		color: rgb(55 65 81);
		border-color: rgb(55 65 81);
	}

	:global(.dark) .tag-btn-reset {
		color: rgb(209 213 219);
		border-color: rgb(209 213 219);
	}
</style>
