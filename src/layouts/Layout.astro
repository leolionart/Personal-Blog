---
import { SEO } from 'astro-seo';
import { ClientRouter } from 'astro:transitions';
import Footer from '../components/Footer.astro';
import BackToTop from '../components/BackToTop.astro';
import ModeToggle from '../components/ModeToggle.astro';
import { SITE_NAME, SITE_DESCRIPTION, SITE_OG_IMAGE } from '../consts';

interface Props {
	title: string;
	description?: string;
	ogImage?: string;
	ogType?: 'website' | 'article';
	noindex?: boolean;
}

const { title, description = SITE_DESCRIPTION, ogImage = SITE_OG_IMAGE, ogType = 'website', noindex = false } = Astro.props;
const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const fullTitle = title ? `${title} — ${SITE_NAME}` : SITE_NAME;
const navLinks = {
	"/":"Blog",
	"/resume":"Resume"
}
---

<!doctype html>
<html lang="vi">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width" />
		<link rel="icon" type="image/png" href="/me_avatar.png" />
		<meta name="generator" content={Astro.generator} />
		<SEO
			title={fullTitle}
			description={description}
			canonical={canonicalURL.href}
			noindex={noindex}
			openGraph={{
				basic: {
					title: fullTitle,
					type: ogType,
					image: new URL(ogImage, Astro.site).href,
				},
				optional: {
					description: description,
					siteName: SITE_NAME,
					locale: 'vi_VN',
				},
			}}
			twitter={{
				card: 'summary_large_image',
				title: fullTitle,
				description: description,
				image: new URL(ogImage, Astro.site).href,
			}}
		/>
		<link rel="alternate" type="application/rss+xml" title={SITE_NAME} href={new URL('/rss.xml', Astro.site).href} />
		<link rel="preload" href="/fonts/JetBrainsMono-latin.woff2" as="font" type="font/woff2" crossorigin />
		<link rel="preload" href="/fonts/JetBrainsMono-vietnamese.woff2" as="font" type="font/woff2" crossorigin />
		<link rel="stylesheet" href="/print-resume.css" media="print" />
		<ClientRouter />
		<script is:inline>
			(function() {
				function applyTheme() {
					const stored = localStorage.getItem('theme');
					const isDark = stored === 'dark' || (stored === null && window.matchMedia('(prefers-color-scheme: dark)').matches);

					if (isDark) {
						document.documentElement.classList.add('dark');
					} else {
						document.documentElement.classList.remove('dark');
					}
				}

				// Apply theme on initial load
				applyTheme();

				// Reapply theme on view transitions
				document.addEventListener('astro:after-swap', applyTheme);
			})();
		</script>
	</head>
	<body class="font-mono bg-white dark:bg-gray-900 c-gray-900 dark:c-gray-100 transition-colors">
		<nav class="border-b-1 border-b-gray-200 dark:border-b-gray-800">
			<div class="flex items-center justify-between border-x-1 border-gray-200 dark:border-gray-800 pl-3 sm:pl-4 md:pl-5 wrapper mx-auto">
				<a href="/" class="text-sm sm:text-base md:text-lg lg:text-xl hover:opacity-70 transition-opacity cursor-pointer font-700" title="Back to home">AI TRAN</a>
				<div class="flex items-center">
					<ul class="grid grid-auto-flow-col list-none m-0 p-0">
						{Object.entries(navLinks).map(([href, title]) => {
							return <li class="grid-col-[span_1] block before:content-none p-0 m-0">
								<a href={href} class="text-xs sm:text-xs md:text-sm px-2 sm:px-3 md:px-5 py-3 sm:py-4 md:py-6 lg:py-8 tracking-0.1 block hover:bg-gray-50 dark:hover:bg-gray-800 active:bg-gray-100 dark:active:bg-gray-700 transition-colors">{title}</a>
							</li>
						})}
					</ul>
					<button id="nav-search-btn" aria-label="Search posts" class="border-1 bg-transparent border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-800 active:bg-gray-200 dark:active:bg-gray-700 cursor-pointer grid place-content-center h-9 w-9 transition-colors">
						<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" x2="16.65" y1="21" y2="16.65"></line></svg>
					</button>
					<ModeToggle />
				</div>
			</div>
		</nav>
		<slot />
		<BackToTop />
		<Footer />
		<script>
			function initNavSearch() {
				const btn = document.getElementById('nav-search-btn');
				if (!btn) return;
				btn.addEventListener('click', () => {
					const input = document.getElementById('search-input') as HTMLInputElement | null;
					if (input) {
						input.focus();
						input.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
					} else {
						window.location.href = '/?focus=search';
					}
				});
				document.addEventListener('keydown', (e) => {
					if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
						e.preventDefault();
						const input = document.getElementById('search-input') as HTMLInputElement | null;
						if (input) {
							input.focus();
							input.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
						} else {
							window.location.href = '/?focus=search';
						}
					}
				});
			}
			initNavSearch();
			document.addEventListener('astro:after-swap', initNavSearch);
		</script>
	</body>
</html>
<style is:global>
	/* Self-hosted JetBrains Mono with unicode-range subsetting */
	@font-face {
		font-family: 'JetBrains Mono';
		font-style: normal;
		font-weight: 100 800;
		font-display: swap;
		src: url('/fonts/JetBrainsMono-vietnamese.woff2') format('woff2');
		unicode-range: U+0102-0103, U+0110-0111, U+0128-0129, U+0168-0169, U+01A0-01A1, U+01AF-01B0, U+0300-0301, U+0303-0304, U+0308-0309, U+0323, U+0329, U+1EA0-1EF9, U+20AB;
	}
	@font-face {
		font-family: 'JetBrains Mono';
		font-style: normal;
		font-weight: 100 800;
		font-display: swap;
		src: url('/fonts/JetBrainsMono-latin-ext.woff2') format('woff2');
		unicode-range: U+0100-02BA, U+02BD-02C5, U+02C7-02CC, U+02CE-02D7, U+02DD-02FF, U+0304, U+0308, U+0329, U+1D00-1DBF, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
	}
	@font-face {
		font-family: 'JetBrains Mono';
		font-style: normal;
		font-weight: 100 800;
		font-display: swap;
		src: url('/fonts/JetBrainsMono-latin.woff2') format('woff2');
		unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
	}

	html {
		scroll-behavior: smooth;
	}
	html,
	body {
		height: 100%;
		min-height: 100vh;
	}
	body {
		display: flex;
		flex-flow: column;
	}
	body > main {
		flex: 1;
	}
	/* ── Headings ── */
	.content-wrapper :is(h1,h2,h3,h4,h5,h6) {
		font-weight: 700;
		margin-top: 2em;
		margin-bottom: 0.5em;
		line-height: 1.3;
	}
	.content-wrapper :is(h1,h2,h3,h4,h5,h6):first-child {
		margin-top: 0;
	}
	.content-wrapper h1 { font-size: 1.5rem; }
	.content-wrapper h2 { font-size: 1.35rem; }
	.content-wrapper h3 { font-size: 1.2rem; }
	.content-wrapper h4 { font-size: 1.1rem; }
	.content-wrapper h5,
	.content-wrapper h6 {
		font-weight: 600;
		font-size: 1rem;
	}
	@media (min-width: 768px) {
		.content-wrapper h1 { font-size: 2.25rem; }
		.content-wrapper h2 { font-size: 1.875rem; }
		.content-wrapper h3 { font-size: 1.5rem; }
		.content-wrapper h4 { font-size: 1.35rem; }
		.content-wrapper h5,
		.content-wrapper h6 { font-size: 1.1rem; }
	}

	/* ── Paragraphs ── */
	.content-wrapper p {
		margin-top: 1em;
		line-height: 1.7;
	}

	/* ── Links ── */
	.content-wrapper a {
		text-decoration: underline;
		text-underline-offset: 3px;
		text-decoration-thickness: 1px;
		transition: opacity 0.15s;
	}
	.content-wrapper a:hover {
		opacity: 0.7;
	}

	/* ── Bold, Italic, Strikethrough ── */
	.content-wrapper strong { font-weight: 700; }
	.content-wrapper em { font-style: italic; }
	.content-wrapper del {
		text-decoration: line-through;
		opacity: 0.6;
	}

	/* ── Lists (GitBook-style alignment) ── */
	.content-wrapper ul,
	.content-wrapper ol {
		margin-top: 1em;
		padding-left: 0;
		list-style: none;
	}
	.content-wrapper li {
		margin-top: 0.4em;
		line-height: 1.7;
		padding-left: 1.5em;
		position: relative;
	}
	/* Custom bullet markers for consistent alignment */
	.content-wrapper ul > li::before {
		content: '•';
		position: absolute;
		left: 0;
		color: currentColor;
		opacity: 0.5;
	}
	.content-wrapper ol {
		counter-reset: ol-counter;
	}
	.content-wrapper ol > li {
		counter-increment: ol-counter;
	}
	.content-wrapper ol > li::before {
		content: counter(ol-counter) '.';
		position: absolute;
		left: 0;
		font-size: 0.875em;
		opacity: 0.5;
	}
	/* Nested lists */
	.content-wrapper li > ul,
	.content-wrapper li > ol {
		margin-top: 0.25em;
		padding-left: 0;
	}
	.content-wrapper li > ol {
		counter-reset: ol-counter;
	}

	/* ── Task Lists (GFM) ── */
	.content-wrapper ul:has(> li > input[type="checkbox"]) > li::before {
		content: none;
	}
	.content-wrapper ul:has(> li > input[type="checkbox"]) > li {
		padding-left: 0;
	}
	.content-wrapper li > input[type="checkbox"] {
		margin-right: 0.5em;
		vertical-align: middle;
	}

	/* ── Blockquote ── */
	.content-wrapper blockquote {
		margin-top: 1em;
		border-left: 3px solid currentColor;
		padding-left: 1.25em;
		opacity: 0.85;
		font-style: italic;
	}
	.content-wrapper blockquote > blockquote {
		margin-top: 0.5em;
	}

	/* ── Inline Code ── */
	.content-wrapper :not(pre) > code {
		font-size: 0.875em;
		padding: 0.15em 0.4em;
		border-radius: 3px;
		background-color: rgb(229 231 235); /* gray-200 */
	}
	.dark .content-wrapper :not(pre) > code {
		background-color: rgb(55 65 81); /* gray-700 */
	}

	/* ── Code Blocks ── */
	.content-wrapper pre {
		margin-top: 1em;
		padding: 0.75rem;
		border-radius: 4px;
		overflow-x: auto;
		font-size: 0.75rem;
		line-height: 1.6;
		background-color: rgb(31 41 55) !important; /* gray-800 */
		color: rgb(229 231 235); /* gray-200 */
	}
	@media (min-width: 768px) {
		.content-wrapper pre {
			padding: 1.25rem;
			font-size: 0.875rem;
		}
	}
	.content-wrapper pre > code {
		background: none;
		padding: 0;
		border-radius: 0;
		font-size: inherit;
	}

	/* ── Images ── */
	.content-wrapper img {
		margin-top: 1.5em;
		margin-bottom: 1.5em;
		max-width: 100%;
		height: auto;
		border-radius: 4px;
		border: 1px solid rgb(229 231 235);
	}
	.dark .content-wrapper img {
		border-color: rgb(55 65 81);
	}

	/* ── Tables ── */
	.content-wrapper table {
		margin-top: 1.5em;
		width: 100%;
		border-collapse: collapse;
		font-size: 0.75rem;
		overflow-x: auto;
		display: block;
	}
	@media (min-width: 768px) {
		.content-wrapper table { font-size: 0.875rem; }
	}
	.content-wrapper thead {
		border-bottom: 2px solid currentColor;
	}
	.content-wrapper th {
		font-weight: 700;
		text-align: left;
		padding: 0.5em 0.5em;
	}
	.content-wrapper td {
		padding: 0.5em 0.5em;
		border-bottom: 1px solid rgb(229 231 235);
	}
	.dark .content-wrapper td {
		border-bottom-color: rgb(55 65 81);
	}
	.content-wrapper tr:last-child td {
		border-bottom: none;
	}

	/* ── Horizontal Rule ── */
	.content-wrapper hr {
		margin-top: 2em;
		margin-bottom: 2em;
		border: none;
		border-top: 1px solid rgb(209 213 219); /* gray-300 */
	}
	.dark .content-wrapper hr {
		border-top-color: rgb(75 85 99); /* gray-600 */
	}

	/* ── Definition Lists ── */
	.content-wrapper dl { margin-top: 1em; }
	.content-wrapper dt {
		font-weight: 700;
		margin-top: 1em;
	}
	.content-wrapper dd {
		padding-left: 1.5em;
		margin-top: 0.25em;
	}

	/* ── Abbreviations ── */
	.content-wrapper abbr[title] {
		text-decoration: underline dotted;
		cursor: help;
	}

	/* ── Keyboard / Mark ── */
	.content-wrapper kbd {
		font-size: 0.875em;
		padding: 0.1em 0.4em;
		border: 1px solid rgb(209 213 219);
		border-radius: 3px;
		box-shadow: 0 1px 0 rgb(209 213 219);
	}
	.dark .content-wrapper kbd {
		border-color: rgb(75 85 99);
		box-shadow: 0 1px 0 rgb(75 85 99);
	}
	.content-wrapper mark {
		background-color: rgb(254 240 138); /* yellow-200 */
		padding: 0.1em 0.2em;
		border-radius: 2px;
	}

	/* ── Footnotes (remark-gfm) ── */
	.content-wrapper .footnotes {
		margin-top: 3em;
		padding-top: 1.5em;
		border-top: 1px solid rgb(209 213 219);
		font-size: 0.875rem;
	}
	.dark .content-wrapper .footnotes {
		border-top-color: rgb(75 85 99);
	}
	.content-wrapper sup a {
		font-size: 0.75em;
		text-decoration: none;
		padding: 0 0.2em;
	}

	/* ── Details / Summary ── */
	.content-wrapper details {
		margin-top: 1em;
		border: 1px solid rgb(229 231 235);
		border-radius: 4px;
		padding: 0.75em 1em;
	}
	.dark .content-wrapper details {
		border-color: rgb(55 65 81);
	}
	.content-wrapper summary {
		cursor: pointer;
		font-weight: 600;
	}
	.content-wrapper details[open] summary {
		margin-bottom: 0.5em;
	}

	/* ── Aside / Callout ── */
	.content-wrapper aside {
		margin-top: 1.5em;
		padding: 1em 1.25em;
		border-left: 3px solid rgb(59 130 246); /* blue-500 */
		background-color: rgb(239 246 255); /* blue-50 */
		border-radius: 0 4px 4px 0;
		font-size: 0.9rem;
	}
	.dark .content-wrapper aside {
		background-color: rgb(30 58 138 / 0.2); /* blue-900/20 */
	}

	/* ── Scroll Reveal Animations ── */
	@keyframes fade-up {
		from { opacity: 0; transform: translateY(20px); }
		to { opacity: 1; transform: translateY(0); }
	}
	@keyframes fade-in {
		from { opacity: 0; }
		to { opacity: 1; }
	}
	.animate-on-scroll {
		opacity: 0;
	}
	.animate-on-scroll.is-visible {
		animation: fade-up 0.6s ease-out forwards;
	}
	.animate-on-scroll.fade-only.is-visible {
		animation: fade-in 0.5s ease-out forwards;
	}
	/* Stagger delays */
	.animate-on-scroll[data-delay="1"] { animation-delay: 0.1s; }
	.animate-on-scroll[data-delay="2"] { animation-delay: 0.2s; }
	.animate-on-scroll[data-delay="3"] { animation-delay: 0.3s; }
	.animate-on-scroll[data-delay="4"] { animation-delay: 0.4s; }

	@media (prefers-reduced-motion: reduce) {
		.animate-on-scroll {
			opacity: 1 !important;
			animation: none !important;
		}
	}

	/* Touch optimization for in-app browsers (Facebook, Zalo, etc.) */
	a, button, [role="button"], input, select, textarea, .tag-btn {
		touch-action: manipulation;
	}

	/* Interactive press feedback — buttons and button-like links */
	button:not(#backToTopBtn):active,
	[role="button"]:active,
	nav a:active,
	a[class*="border-"]:active {
		transform: scale(0.97);
		transition: transform 0.06s ease-out;
	}
</style>
<script>
	function initScrollReveal() {
		const observer = new IntersectionObserver((entries) => {
			entries.forEach(entry => {
				if (entry.isIntersecting) {
					entry.target.classList.add('is-visible');
					observer.unobserve(entry.target);
				}
			});
		}, { threshold: 0.1 });

		document.querySelectorAll('.animate-on-scroll').forEach(el => {
			// Check if element is already in viewport
			const rect = el.getBoundingClientRect();
			if (rect.top < window.innerHeight && rect.bottom > 0) {
				// Element is in viewport, show immediately
				el.classList.add('is-visible');
			} else {
				// Element is below viewport, observe for scroll
				observer.observe(el);
			}
		});
	}
	initScrollReveal();
	document.addEventListener('astro:after-swap', initScrollReveal);
</script>
